# Ly[x]an AOS — Project Context & Architecture

Этот документ является **единым источником правды** для проекта Ly[x]an AOS (Agentic Operation System). Все технические решения и генерация кода должны строго соответствовать описанным ниже правилам и бизнес-логике.

---

## 1. Видение проекта (Vision)

**Ly[x]an AOS** — это ERP-система нового поколения для электронной коммерции (E-commerce), входящая в экосистему Ly[x]an.

* **Основная цель:** Управление продажами FMCG брендов в разных странах и на разных маркетплейсах (на старте — Ozon).

* **Ключевая особенность (Agentic-First):** Система проектируется не просто как интерфейс для людей, а как плацдарм для AI-агентов.

    * *Этап 1:* Инструмент для людей + простые агенты-помощники.

    * *Этап 2:* Автономные агенты, выполняющие рутинные задачи (контент, реклама, поставки).

    * *Этап 3:* Оркестрация мульти-агентов.

---

## 2. Технический стек и Архитектура

### Репозиторий

* **Monorepo:** Управляется через `pnpm workspaces`.

* **Структура:**

    * `/backend` (NestJS)

    * `/frontend` (Next.js App Router)

    * `/shared` (Общие типы и DTO)

    * `/infra` (Docker, конфигурации)

### Backend (Node.js)

* **Framework:** NestJS (Модульная архитектура).

* **Database:** PostgreSQL + Prisma ORM.

* **Role:**

    1.  REST API для Frontend.

    2.  **Tool Provider** для AI-агентов (предоставляет "жирные" методы API для выполнения бизнес-функций).

* **Integrations:** Ozon Seller API (приоритет), возможность расширения на другие MP.

### Frontend

* **Framework:** Next.js 15+ (App Router).

* **UI:** Tailwind CSS, Shadcn/UI.

### AI & Orchestration

* **Orchestrator:** **n8n** (Self-hosted).

* **Логика:** "Мозги" агентов на начальном этапе живут в n8n.

* **Связь:**

    * `NestJS -> n8n`: Через Webhooks (курлы) при наступлении событий или нажатии кнопок в UI.

    * `n8n -> NestJS`: Через REST API.

---

## 3. Бизнес-домены и Логика

### 3.1. SCM (Supply Chain Management) — Приоритет №1

Модель: **Контрактное производство**. Мы не управляем станками, мы управляем *Заказами на производство*.

* **Supplier (Поставщик):** Универсальная сущность. Может быть:

    * Производителем товара (Manufacturer).

    * Поставщиком упаковки/тары.

    * Провайдером услуг (сборка, наклейка этикеток).

* **Production Order (Заказ на производство):**

    * Мы заказываем у `Supplier` партию товара.

    * В заказе могут использоваться компоненты (сырье, тара), которые мы либо поставляем сами, либо закупаем у этого же поставщика.

* **Inventory:** Система ведет строгий учет остатков на складах (`Warehouses`).

### 3.2. BCM (Brand & Catalog Management) — Приоритет №2

Управление контентом для мультиканальных продаж.

* **Разделение сущностей:**

    * `ScmProduct`: Внутренний эталон продукта (физический товар).

    * `Product` (Listing): Карточка товара на конкретном маркетплейсе (Ozon, WB и т.д.).

* **Версионирование:** Любые изменения контента (описания, заголовки) сохраняются в истории версий (`ListingContentVersion`).

### 3.3. Agents & Automation

* **Паттерн работы:** Бэкенд не содержит сложной LLM-логики внутри. Он предоставляет API-эндпоинты (Tools).

* **Триггеры:** В таблице `AgentScenario` хранятся вебхуки n8n.

* **Auth (Service-to-Service):**

    * n8n авторизуется в NestJS через **API Key**.

    * Заголовок: `X-API-KEY`.

    * Guard: `ApiKeyGuard`.

### 3.4. Finance

* **Source of Truth:** Система является единственным источником правды о финансах.

* **Метод:** Мы загружаем "сырые" данные (банковские выписки, отчеты реализации маркетплейсов) и сами рассчитываем P&L, Cashflow и Balance. Мы не доверяем агрегированным цифрам извне без пересчета.

### 3.5. Organization

* **Multitenancy:** Поддержка нескольких юрлиц (`LegalEntity`), брендов (`Brand`) и стран (`Country`) в одной инсталляции.

---

## 4. Правила разработки (Coding Rules)

### 4.1. Общие

* **Язык кода и комментариев:** **Strictly English**.

* **Типизация:** Строгая. Избегать `any`. Использовать DTO и интерфейсы из `/shared`, где это возможно.

### 4.2. Тестирование

* Покрытие тестами **обязательно** для новой функциональности.

* **Unit Tests:** Для сложной бизнес-логики сервисов.

* **E2E Tests:** Для контроллеров и проверки API контрактов.

### 4.3. Взаимодействие с базой (Prisma)

* Не использовать сырые SQL запросы без крайней необходимости.

* При миграциях обновлять `schema.prisma` и генерировать клиент (`pnpm db:generate`).

---

## 5. План разработки (Roadmap Priorities)

1.  **SCM Foundation (Current Focus):**

    * Реализация CRUD для Suppliers (с типами услуг/производства).

    * ScmProducts (внутренний каталог).

    * Production Orders (жизненный цикл заказа на производство).

    * UI для менеджеров.

2.  **BCM & Ozon Integration:**

    * Интеграция с Ozon Seller API (обновление остатков, цен, контента).

    * Механизм версионирования контента.

3.  **Agents Integration (n8n):**

    * Настройка API Key авторизации.

    * Создание первых вебхуков для вызова n8n (например, "Сгенерировать описание").





















