1. Общие принципы

Главный приоритет — не терять данные.
Любые изменения схемы БД, моделей, DTO и форм должны быть спроектированы так, чтобы максимально сохранить существующие данные.

Не “обнуляй” проект ради быстрого фикса.
Запрещено:

удалять таблицы без явной необходимости;

полностью пересоздавать схему БД, если можно обойтись миграцией;

менять названия/тип полей, не предусмотрев миграцию данных.

Если видишь, что сейчас проще “всё выкинуть и сделать заново”, ищи вариант эволюционного изменения, а не революции.

2. Работа с Prisma и схемой БД

Проект использует Prisma + PostgreSQL.
Все изменения в структуре БД делаем через Prisma migrations, а не ручные DROP TABLE / ALTER TABLE в отрыве от миграций.

Запрещено без явного указания пользователя:

запускать prisma migrate reset;

удалять/переименовывать таблицы и поля, если это может сломать существующие данные;

менять тип поля на несовместимый (например, String → Int) без шага миграции.

При изменении модели:

если нужно добавить новое поле — добавь поле в schema.prisma, создай миграцию (prisma migrate dev), адаптируй seed и код.

если нужно переименовать поле, делай это в ДВА ШАГА:

Добавить новое поле newField, обновить код и миграцию.

(Опционально, вторым шагом) перенести данные и удалить старое поле в отдельной миграции, только если это безопасно.

Если в схеме есть старые индексы (как @@index([type])) и поле уже удалено, сначала:

убрать индекс из schema.prisma,

проверить, что нигде больше это поле не используется,

только потом запускать prisma generate и миграции.

3. Существующие данные и миграции

Перед любым разрушающим изменением (удаление поля/таблицы, изменение типа) нужно:

объяснить в комментарии, какие данные могут пострадать;

предложить стратегию миграции (копирование в новое поле, преобразование, default-значения и т.п.).

Если уже есть данные (например, поставщики, продукты):

при добавлении новых полей задавай разумные значения по умолчанию в миграции/seed’е (DEFAULT '', DEFAULT 'ACTIVE', NULL там, где допустимо).

не удаляй существующие записи из таблиц, если на это нет прямого указания в ТЗ.

Seed-скрипты:

не стирай существующий seed, а расширяй его:

добавляй новые поля в уже создаваемые сущности;

следи, чтобы сид не ломался при добавлении/изменении полей.

Seed нужен для минимального набора тестовых данных, а не для “очистки” БД.

4. Формы и API (Suppliers / SCM / BCM)

При изменении форм (например, Supplier create/edit) запрещено:

бессмысленно переименовывать поля, если это ломает маппинг с БД;

удалять поля, которые уже используются на бэке/в БД, без согласования.

Если меняешь структуру формы:

убедись, что DTO на бэке соответствует форме;

маппинг запроса → Prisma-модель покрывает все необходимые поля;

поля, которые были раньше, но теперь отображаются иначе (например, type → types), должны быть корректно обработаны.

Если существующие записи могут конфликтовать с новыми правилами (например, single type → массив types):

предусмотри, как их интерпретировать:

type = 'MANUFACTURER' → types = ['MANUFACTURER'] и т.п.

5. Ошибки в рантайме и данные

Если появилась ошибка вида 400 Bad Request или 500 Internal Server Error при работе с сущностями (поставщик, продукт и т.п.), не решай проблему удалением таблиц или сидов.

Вместо этого:

посмотри на ответ бэка и стек-трейс;

поправь DTO, валидацию, enum’ы, маппинг данных;

если причина — несоответствие схемы и данных, предложи миграцию.

6. Docker и окружение

Не меняй:

имена контейнеров (aos-backend, aos-frontend, aos-postgres, aos-redis, aos-n8n);

порты (3000, 3001, 5433→5432, 6379, 5678);

имена БД и пользователей, если это не оговорено.

После серьёзных изменений всегда проверяй, что:

pnpm lint и pnpm build проходят;

pnpm docker:up проходит без ошибок миграций и генерации Prisma.

7. Если что-то непонятно

Если есть сомнения, нужно ли удалять/ломать существующие данные, предпочтительный вариант —:

сохранить всё как есть и предложить варианты решения в комментариях/описании изменений,
а не принимать радикальное решение в коде.
---
alwaysApply: true
---
