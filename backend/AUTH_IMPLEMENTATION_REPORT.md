# –û—Ç—á—ë—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –¢–ó ‚Ññ4

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### 1. –ú–æ–¥–µ–ª–∏ –≤ Prisma ‚úÖ
–ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –º–æ–¥–µ–ª–∏ User –∏ Role –≤ `schema.prisma`:
- ‚úÖ `Role` —Å –ø–æ–ª—è–º–∏ `id`, `name` (unique), `users`
- ‚úÖ `User` —Å –ø–æ–ª—è–º–∏ `id`, `email` (unique), `password`, `roleId`, `role`, timestamps

### 2. AuthModule ‚úÖ

#### 2.1. DTO ‚úÖ
- ‚úÖ `LoginDto` ‚Äî –¥–ª—è –≤—Ö–æ–¥–∞ (email, password)
- ‚úÖ `CreateUserDto` ‚Äî –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `UpdateUserDto` ‚Äî –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### 2.2. AuthService ‚úÖ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏:
- ‚úÖ `validateUser(email, password)` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ bcrypt
- ‚úÖ `login(user)` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è access –∏ refresh —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ `refreshToken(refreshToken)` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ `hashPassword(password)` ‚Äî —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤:**
- Access token: 15 –º–∏–Ω—É—Ç
- Refresh token: 7 –¥–Ω–µ–π
- JWT_SECRET –∏–∑ .env

#### 2.3. AuthController ‚úÖ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
- ‚úÖ `POST /api/auth/login` ‚Äî –≤—Ö–æ–¥, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ cookies (access_token, refresh_token)
- ‚úÖ `POST /api/auth/refresh` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ refresh_token
- ‚úÖ `POST /api/auth/logout` ‚Äî –æ—á–∏—Å—Ç–∫–∞ cookies

### 3. JWT –∏ Guards ‚úÖ

#### 3.1. JwtModule ‚úÖ
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω JwtModule —Å JWT_SECRET –∏–∑ .env
- ‚úÖ –°—Ä–æ–∫ –∂–∏–∑–Ω–∏ access —Ç–æ–∫–µ–Ω–∞: 15 –º–∏–Ω—É—Ç
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ConfigModule

#### 3.2. JwtAuthGuard ‚úÖ
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ `common/guards/jwt-auth.guard.ts`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç access_token –∏–∑ cookies
- ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ request.user —á–µ—Ä–µ–∑ JWT Strategy

#### 3.3. RolesGuard ‚úÖ
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ `common/guards/roles.guard.ts`
- ‚úÖ –ß–∏—Ç–∞–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–µ —Ä–æ–ª–∏ –∏–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ @Roles
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç request.user.role
- ‚úÖ –í—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç ForbiddenException –ø—Ä–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏

#### 3.4. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä @Roles ‚úÖ
- ‚úÖ –°–æ–∑–¥–∞–Ω –≤ `common/decorators/roles.decorator.ts`
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Ä–æ–ª–µ–π: `@Roles('Admin', 'Manager')`

### 4. UsersModule (CRUD) ‚úÖ

#### 4.1. UsersService ‚úÖ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–µ—Ç–æ–¥—ã:
- ‚úÖ `findAll()` ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–±–µ–∑ –ø–∞—Ä–æ–ª–µ–π)
- ‚úÖ `findOne(id)` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
- ‚úÖ `create(dto)` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–∞—Ä–æ–ª—è
- ‚úÖ `update(id, dto)` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `remove(id)` ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### 4.2. UsersController ‚úÖ
–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∑–∞—â–∏—â–µ–Ω—ã `@UseGuards(JwtAuthGuard, RolesGuard)` –∏ `@Roles('Admin')`:
- ‚úÖ `GET /api/users` ‚Äî —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ `GET /api/users/:id` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `POST /api/users` ‚Äî —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `PATCH /api/users/:id` ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `DELETE /api/users/:id` ‚Äî —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 5. –°–∏–¥—ã —Ä–æ–ª–µ–π –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ‚úÖ

#### 5.1. –°–∫—Ä–∏–ø—Ç —Å–∏–¥–æ–≤ ‚úÖ
- ‚úÖ –°–æ–∑–¥–∞–Ω `src/seeds/seed.ts`
- ‚úÖ –°–æ–∑–¥–∞—ë—Ç —Ä–æ–ª–∏: `Admin`, `Manager`
- ‚úÖ –°–æ–∑–¥–∞—ë—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:
  - Email: `admin@aos.local`
  - Password: `ChangeMe123!` (—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —á–µ—Ä–µ–∑ bcrypt)

#### 5.2. –ö–æ–º–∞–Ω–¥–∞ seed ‚úÖ
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –≤ `package.json`:
  ```json
  "seed": "ts-node -r tsconfig-paths/register src/seeds/seed.ts"
  ```
- ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: `pnpm run seed` –∏–ª–∏ `pnpm -F backend seed`

### 6. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ main.ts ‚úÖ
- ‚úÖ Cookie-parser —É–∂–µ –ø–æ–¥–∫–ª—é—á—ë–Ω
- ‚úÖ ValidationPipe –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ
- ‚úÖ –§–∏–ª—å—Ç—Ä—ã –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
- ‚úÖ –ü—Ä–µ—Ñ–∏–∫—Å `/api` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

### 7. README –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ
–î–æ–±–∞–≤–ª–µ–Ω—ã —Ä–∞–∑–¥–µ–ª—ã:
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ auth –∏ users
- ‚úÖ –ü—Ä–∏–º–µ—Ä .env —Å JWT_SECRET
- ‚úÖ –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ª–æ–≥–∏–Ω
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é —Å–∏–¥–æ–≤
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞—â–∏—Ç—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login.dto.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-user.dto.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update-user.dto.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ strategies/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ jwt.strategy.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.module.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ users/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ users.controller.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ users.service.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ users.module.ts
‚îÇ   ‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt-auth.guard.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ roles.guard.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ decorators/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ roles.decorator.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ current-user.decorator.ts
‚îÇ   ‚îî‚îÄ‚îÄ seeds/
‚îÇ       ‚îî‚îÄ‚îÄ seed.ts
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–ü–∞—Ä–æ–ª–∏:**
   - –•—Ä–∞–Ω—è—Ç—Å—è –≤ –≤–∏–¥–µ bcrypt-—Ö–µ—à–µ–π (10 rounds)
   - –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ API –æ—Ç–≤–µ—Ç–∞—Ö

2. **–¢–æ–∫–µ–Ω—ã:**
   - Access token: –∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ (15 –º–∏–Ω—É—Ç)
   - Refresh token: –¥–æ–ª–≥–∏–π —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ (7 –¥–Ω–µ–π)
   - –•—Ä–∞–Ω—è—Ç—Å—è –≤ httpOnly cookies (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
   - SameSite: lax (–∑–∞—â–∏—Ç–∞ –æ—Ç CSRF)

3. **–ó–∞—â–∏—Ç–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:**
   - JwtAuthGuard –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞
   - RolesGuard –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω—É–∂–Ω–æ–π —Ä–æ–ª–∏
   - –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç —Ä–æ–ª—å Admin

## üìã API Endpoints

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–ø—É–±–ª–∏—á–Ω—ã–µ)
- `POST /api/auth/login` ‚Äî –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
- `POST /api/auth/refresh` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- `POST /api/auth/logout` ‚Äî –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (—Ç—Ä–µ–±—É–µ—Ç —Ä–æ–ª—å Admin)
- `GET /api/users` ‚Äî —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `GET /api/users/:id` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `POST /api/users` ‚Äî —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `PATCH /api/users/:id` ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `DELETE /api/users/:id` ‚Äî —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/aos"
JWT_SECRET="your-secret-key-here"
```

### 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
npx prisma migrate dev --name init
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```bash
pnpm run seed
```

### 4. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```bash
pnpm run start:dev
```

### 5. –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
```bash
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@aos.local","password":"ChangeMe123!"}' \
  -c cookies.txt
```

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ - –í–°–ï –í–´–ü–û–õ–ù–ï–ù–´

1. ‚úÖ –ö–æ–¥ –º–æ–¥—É–ª–µ–π auth (module, service, controller)
2. ‚úÖ –ö–æ–¥ –º–æ–¥—É–ª–µ–π users (module, service, controller)
3. ‚úÖ Guards –∏ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
4. ‚úÖ Schema.prisma –ø—Ä–æ–≤–µ—Ä–µ–Ω –∏ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
5. ‚úÖ –°–∫—Ä–∏–ø—Ç —Å–∏–¥–æ–≤ —Å–æ–∑–¥–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
6. ‚úÖ –ö–æ–º–∞–Ω–¥–∞ seed –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ package.json
7. ‚úÖ README –æ–±–Ω–æ–≤–ª—ë–Ω —Å –ø–æ–ª–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º

## üéØ –°—Ç–∞—Ç—É—Å

**‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**







