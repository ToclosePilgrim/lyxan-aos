// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. Org Structure
// ============================================

model Country {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  brands                  BrandCountry[]
  legalEntities           LegalEntity[]
  marketplaceCountries    MarketplaceCountry[]
  marketplaceIntegrations MarketplaceIntegration[]
  suppliers               Supplier[]
  warehouses              Warehouse[]
  productionOrders        ProductionOrder[]        @relation("ProductionOrderCountry")

  @@map("countries")
}

model Brand {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  description String?  @db.Text
  toneOfVoice String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  countries               BrandCountry[]
  products                Product[]
  scmProducts             ScmProduct[]
  marketplaceIntegrations MarketplaceIntegration[]

  @@map("brands")
}

model LegalEntity {
  id          String   @id @default(cuid())
  name        String
  countryId   String
  country     Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
  inn         String?
  kpp         String?
  ogrn        String?
  legalAddr   String?
  bankName    String?
  bik         String?
  account     String?
  corrAccount String?
  director    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  brandCountries BrandCountry[]

  @@index([countryId])
  @@map("legal_entities")
}

model BrandCountry {
  brandId       String
  countryId     String
  legalEntityId String?

  brand       Brand        @relation(fields: [brandId], references: [id], onDelete: Cascade)
  country     Country      @relation(fields: [countryId], references: [id], onDelete: Cascade)
  legalEntity LegalEntity? @relation(fields: [legalEntityId], references: [id], onDelete: SetNull)

  @@id([brandId, countryId])
  @@index([brandId])
  @@index([countryId])
  @@index([legalEntityId])
  @@map("brand_countries")
}

model Marketplace {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  logoUrl   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  markets                MarketplaceCountry[]
  products               Product[]
  campaigns              AdCampaign[]
  listingContentVersions ListingContentVersion[]
  integrations           MarketplaceIntegration[]

  @@map("marketplaces")
}

model MarketplaceCountry {
  marketplaceId String
  countryId     String

  marketplace Marketplace @relation(fields: [marketplaceId], references: [id], onDelete: Cascade)
  country     Country     @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@id([marketplaceId, countryId])
  @@index([marketplaceId])
  @@index([countryId])
  @@map("marketplace_countries")
}

// ============================================
// 2. Users & Roles
// ============================================

model Role {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users User[]

  @@map("roles")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  roleId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  role                   Role                    @relation(fields: [roleId], references: [id])
  listingContentVersions ListingContentVersion[]
  productContentVersions ProductContentVersion[]

  @@index([email])
  @@index([roleId])
  @@map("users")
}

// ============================================
// 3. SCM (Supply Chain Management)
// ============================================

// ============================================
// 3.1. SCM Products (Internal Products)
// ============================================

model ScmProduct {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Базовая информация о продукте
  internalName String // внутреннее наименование (обязательное)
  sku          String? // внутренний артикул / SKU (опционально)
  brandId      String?
  brand        Brand?  @relation(fields: [brandId], references: [id], onDelete: SetNull)

  // Описание / состав (минимум)
  baseDescription String? // базовое описание (не под конкретный МП)
  composition     String? @db.Text // состав (если есть)

  /// Технические параметры (используются как источник правды)
  netWeightGrams   Int?
  grossWeightGrams Int?
  lengthMm         Int?
  widthMm          Int?
  heightMm         Int?

  barcode String?

  countryOfOriginCode String? // ISO alpha-2, например "RU"

  /// Дополнительные тех. атрибуты в свободной форме (JSON), для точной подстройки под разные МП
  technicalAttributes Json?

  // Тип продукта
  type ScmProductType @default(PURCHASED)

  // Связь с BCM Listings (существующая модель Product)
  products Product[]

  // Связь с поставщиками
  suppliers ScmProductSupplier[]

  // BOM (Bill of Materials)
  bomItems ScmBomItem[]

  // Production Orders
  productionOrders ProductionOrder[]

  // Stocks
  stocks ScmStock[]

  @@index([brandId])
  @@index([sku])
  @@index([type])
  @@map("scm_products")
}

// ============================================
// 3.2. SCM Supplies & Stocks
// ============================================

model Product {
  id            String   @id @default(cuid())
  brandId       String
  marketplaceId String?
  name          String
  category      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Новая связь на SCM-продукт
  scmProductId String?
  scmProduct   ScmProduct? @relation(fields: [scmProductId], references: [id], onDelete: SetNull)

  // Контентные поля листинга (общие, но в первую очередь под OZON)
  title            String? // Заголовок карточки на маркетплейсе (legacy)
  subtitle         String? // Краткий подзаголовок (если нужен) (legacy)
  shortDescription String? // Краткое описание / bullets в текстовом виде (legacy)
  fullDescription  String? // Полное описание (legacy)
  keywords         String? // Текстовое поле со списком ключей (через запятую/новую строку)
  contentMeta      Json? // для расширений под конкретный маркетплейс (OZON attrs и т.п.) (legacy)

  // Контентные поля для маркетплейса (OZON) с поддержкой AI
  mpTitle            String? @db.Text // Основной заголовок для маркетплейса (OZON title)
  mpSubtitle         String? @db.Text // Краткое описание (если требуется маркетплейсом)
  mpShortDescription String? @db.Text // Краткое описание / benefits (для карточки)
  mpDescription      String? @db.Text // Полное описание товара (HTML/Markdown/plain)
  contentAttributes  Json? // Технические/маркетинговые атрибуты в виде JSON (будущее под OZON attributes)
  aiContentEnabled   Boolean @default(true) // Флаг, что контент этого листинга может управляться AI-агентами

  /// Технические параметры, которые будут отправляться на МП
  netWeightGrams      Int?
  grossWeightGrams    Int?
  lengthMm            Int?
  widthMm             Int?
  heightMm            Int?
  barcode             String?
  countryOfOriginCode String?

  technicalAttributes Json? // Технические атрибуты для маркетплейса

  brand                  Brand                   @relation(fields: [brandId], references: [id], onDelete: Cascade)
  marketplace            Marketplace?            @relation(fields: [marketplaceId], references: [id], onDelete: SetNull)
  skus                   Sku[]
  productCard            ProductCard?
  contentVersions        ListingContentVersion[]
  productContentVersions ProductContentVersion[]
  scmSupplyItems         ScmSupplyItem[]
  inventoryBalances      InventoryBalance[]
  inventoryTransactions  InventoryTransaction[]  @relation("InventoryTransactions")

  @@index([brandId])
  @@index([marketplaceId])
  @@index([scmProductId])
  @@map("products")
}

model Sku {
  id        String   @id @default(cuid())
  productId String
  code      String   @unique
  name      String?
  price     Float?
  cost      Float?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  stocks         Stock[]
  supplies       SupplyItem[]
  financeReports FinanceReport[]
  reviews        Review[]

  @@index([productId])
  @@index([code])
  @@map("skus")
}

model Stock {
  id        String   @id @default(cuid())
  skuId     String
  quantity  Int      @default(0)
  updatedAt DateTime @default(now()) @updatedAt

  sku Sku @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@unique([skuId])
  @@index([skuId])
  @@map("stocks")
}

model Supply {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  status    String
  updatedAt DateTime @updatedAt

  items SupplyItem[]

  @@index([status])
  @@map("supplies")
}

model SupplyItem {
  id       String @id @default(cuid())
  supplyId String
  skuId    String
  quantity Int

  supply Supply @relation(fields: [supplyId], references: [id], onDelete: Cascade)
  sku    Sku    @relation(fields: [skuId], references: [id])

  @@index([supplyId])
  @@index([skuId])
  @@map("supply_items")
}

// ============================================
// 4. BCM (Brand & Catalog Management)
// ============================================

model ProductCard {
  id          String   @id @default(cuid())
  productId   String   @unique
  title       String?
  description String?
  attributes  Json?
  images      Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_cards")
}

// ============================================
// 5. Finance
// ============================================

model FinanceReport {
  id         String   @id @default(cuid())
  skuId      String
  date       DateTime
  quantity   Int
  revenue    Float
  commission Float
  refunds    Float    @default(0)
  createdAt  DateTime @default(now())

  sku Sku @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([skuId])
  @@index([skuId, date])
  @@map("finance_reports")
}

// ============================================
// 6. Advertising
// ============================================

model AdCampaign {
  id            String   @id @default(cuid())
  marketplaceId String
  name          String
  status        String
  budget        Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  marketplace Marketplace @relation(fields: [marketplaceId], references: [id], onDelete: Cascade)
  stats       AdStats[]

  @@index([marketplaceId])
  @@index([status])
  @@map("ad_campaigns")
}

model AdStats {
  id          String   @id @default(cuid())
  campaignId  String
  date        DateTime
  impressions Int?
  clicks      Int?
  spend       Float?
  orders      Int?
  revenue     Float?
  createdAt   DateTime @default(now())

  campaign AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([date])
  @@index([campaignId, date])
  @@map("ad_stats")
}

// ============================================
// 7. Support
// ============================================

model Review {
  id        String   @id @default(cuid())
  skuId     String?
  rating    Int
  text      String?
  date      DateTime
  createdAt DateTime @default(now())

  sku Sku? @relation(fields: [skuId], references: [id], onDelete: SetNull)

  @@index([skuId])
  @@index([date])
  @@index([rating])
  @@map("reviews")
}

model SupportTicket {
  id        String   @id @default(cuid())
  text      String
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("support_tickets")
}

// ============================================
// 8. Agents
// ============================================

model AgentScenario {
  id        String   @id @default(cuid())
  key       String   @unique
  name      String
  endpoint  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  runs AgentRun[]

  @@index([key])
  @@map("agent_scenarios")
}

model AgentRun {
  id         String    @id @default(cuid())
  scenarioId String?
  agentKey   String
  input      Json
  output     Json?
  status     String
  error      String?
  startedAt  DateTime  @default(now())
  finishedAt DateTime?

  scenario AgentScenario?   @relation(fields: [scenarioId], references: [id], onDelete: SetNull)
  logs     IntegrationLog[]

  @@index([agentKey])
  @@index([status])
  @@index([scenarioId])
  @@index([startedAt])
  @@map("agent_runs")
}

// ============================================
// 9. Settings
// ============================================

model Integration {
  id        String   @id @default(cuid())
  key       String   @unique
  name      String
  config    Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@map("integrations")
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
}

model MarketplaceIntegration {
  id String @id @default(cuid())

  name String

  marketplaceId String
  marketplace   Marketplace @relation(fields: [marketplaceId], references: [id], onDelete: Cascade)

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  countryId String
  country   Country @relation(fields: [countryId], references: [id], onDelete: Cascade)

  status     IntegrationStatus @default(ACTIVE)
  lastSyncAt DateTime?

  // Ozon Seller API
  ozonSellerClientId String?
  ozonSellerToken    String?

  // Ozon Performance API
  ozonPerfClientId     String?
  ozonPerfClientSecret String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logs IntegrationLog[]

  @@unique([marketplaceId, brandId, countryId], name: "uniq_marketplace_brand_country")
  @@index([marketplaceId])
  @@index([brandId])
  @@index([countryId])
  @@index([status])
  @@map("marketplace_integrations")
}

enum LogLevel {
  INFO
  WARN
  ERROR
}

enum LogSource {
  MARKETPLACE_INTEGRATION
  AGENT_RUN
}

// ============================================
// 10. SCM Suppliers
// ============================================

enum SupplierType {
  MANUFACTURER
  COMPONENT_SUPPLIER
  PACKAGING_SUPPLIER
  PRINTING_HOUSE
  OTHER
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
  BLACKLISTED
  POTENTIAL
}

enum SupplierRole {
  PRODUCER
  RAW_MATERIAL
  PACKAGING
  PRINTING
  LOGISTICS
  OTHER
}

enum SupplierItemType {
  MATERIAL
  SERVICE
}

enum SupplierItemCategory {
  RAW_MATERIAL
  PACKAGING
  LABEL
  BOX
  SHIPPING_BOX
  PRINTING
  MANUFACTURING
  LOGISTICS
  OTHER
}

enum ScmProductType {
  MANUFACTURED
  PURCHASED
}

enum ProductionOrderStatus {
  DRAFT
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProductionOrderItemStatus {
  PLANNED
  ORDERED
  PARTIALLY_RECEIVED
  RECEIVED
  USED_IN_PRODUCTION
  NOT_NEEDED
}

enum WarehouseType {
  OWN // наш собственный склад
  MANUFACTURER // склад/производство подрядчика
  THIRD_PARTY // 3PL, логистический партнёр
}

enum ScmSupplyStatus {
  DRAFT // черновик
  ORDERED // заказано поставщику
  PARTIAL_RECEIVED // частично получено
  RECEIVED // полностью получено
  CANCELED // отменено
}

enum ScmServiceCategory {
  MANUFACTURING
  LABELING
  PACKAGING
  LOGISTICS_INBOUND
  LOGISTICS_OUTBOUND
  STORAGE
  OTHER
}

enum FinancialDocumentType {
  INVOICE // счёт
  BILL // счёт/счёт на оплату
  ACT // акт выполненных работ
  CREDIT_NOTE // кредит-нота
  OTHER // прочее
  SUPPLY // документ по поставке
  PRODUCTION // документ по производству
  PURCHASE // документ по закупке
  EXPENSE // документ по расходам
  // Legacy values for backward compatibility
  SUPPLY_INVOICE
  PRODUCTION_INVOICE
  SERVICE_INVOICE
}

enum FinancialDocumentDirection {
  INCOMING // к нам (от поставщика)
  OUTGOING // от нас (к клиенту)
}

enum FinancialDocumentStatus {
  DRAFT
  SENT
  PARTIALLY_PAID
  PAID
  CANCELLED
  // Legacy value for backward compatibility
  ISSUED
}

model IntegrationLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  level   LogLevel
  source  LogSource
  message String

  // Ссылка на конкретную интеграцию (может быть null, если лог общий по агентам)
  integrationId String?
  integration   MarketplaceIntegration? @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  // Ссылка на AgentRun, если лог относится к запуску агента
  agentRunId String?
  agentRun   AgentRun? @relation(fields: [agentRunId], references: [id], onDelete: Cascade)

  // Дополнительные данные (payload / error / контекст)
  details Json?

  @@index([integrationId])
  @@index([agentRunId])
  @@map("integration_logs")
}

model Supplier {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name String
  code String @unique

  types  SupplierType[] @default([])
  status SupplierStatus @default(ACTIVE)

  countryId String?
  country   Country? @relation(fields: [countryId], references: [id], onDelete: SetNull)

  suppliesWhat  String? // кратко: что поставляет / производит
  contactPerson String?
  email         String?
  phone         String?
  website       String?

  legalName          String? // юр. наименование
  taxId              String? // ИНН / Tax ID
  registrationNumber String? // ОГРН и аналоги
  legalAddress       String? // юр. адрес
  bankDetails        Json? // банковские реквизиты (как JSON) - legacy, для обратной совместимости

  // Банковские реквизиты (отдельные поля)
  bankAccount         String? // расчётный счёт
  corrAccount         String? // корр. счёт
  bik                 String? // BIC
  bankName            String? // название банка
  extraPaymentDetails String? // доп. платёжная инфа

  // ЭДО и доп. юр. инфо
  edoSystem   String? // система ЭДО (например: "Тензор СБИС")
  edoNumber   String? // идентификатор/адрес ЭДО
  ceoFullName String? // ФИО гендиректора

  tags  String[] // произвольные теги
  notes String?

  legalProfiles      SupplierLegalProfile[]
  scmProductLinks    ScmProductSupplier[]
  items              SupplierItem[]
  supplies           ScmSupply[]
  serviceOperations  ScmServiceOperation[]  @relation("SupplierServiceOperations")
  services           SupplierService[] // каталог услуг поставщика
  financialDocuments FinancialDocument[]    @relation("SupplierFinancialDocuments")
  productionOrders   ProductionOrder[]      @relation("ProductionOrderManufacturer")

  @@index([countryId])
  @@index([status])
  @@map("suppliers")
}

model ScmProductSupplier {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scmProductId String
  supplierId   String
  role         SupplierRole
  isPrimary    Boolean      @default(false)

  leadTimeDays     Int? // срок поставки в днях
  minOrderQty      Int? // минимальный заказ
  purchaseCurrency String? // валюта закупки, например "RUB", "USD"
  purchasePrice    Decimal? @db.Decimal(14, 4)

  notes String?

  scmProduct ScmProduct @relation(fields: [scmProductId], references: [id], onDelete: Cascade)
  supplier   Supplier   @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([scmProductId, supplierId, role])
  @@index([scmProductId])
  @@index([supplierId])
  @@map("scm_product_suppliers")
}

model SupplierLegalProfile {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  countryCode String // "RU", "KZ", "ID" и т.д.

  // Блок РФ-реквизитов (можем использовать только для countryCode = "RU")
  inn  String? // ИНН
  kpp  String? // КПП
  ogrn String? // ОГРН

  legalAddress  String? // юр. адрес
  actualAddress String? // фактический адрес

  bankAccount      String? // р/с
  bankName         String?
  bankBic          String?
  bankCorrAccount  String? // кор/с
  bankExtraDetails String? // доп. информация по оплатам

  edoType   String? // например "СБИС", "Диадок" (EDO System)
  edoNumber String?

  generalDirector String? // ФИО ген. директора (CEO Full Name)

  @@unique([supplierId, countryCode])
  @@index([supplierId])
  @@index([countryCode])
  @@map("supplier_legal_profiles")
}

model SupplierItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  name     String
  code     String
  type     SupplierItemType
  category SupplierItemCategory
  unit     String

  isActive Boolean @default(true)

  description  String?  @db.Text
  notes        String?  @db.Text // дополнительные заметки
  sku          String?
  currency     String?
  price        Decimal? @db.Decimal(14, 4)
  minOrderQty  Decimal? @db.Decimal(14, 4)
  leadTimeDays Int?
  metadata     Json? // резерв для специфики

  bomItems              ScmBomItem[]
  productionOrderItems  ProductionOrderItem[]
  supplyItems           ScmSupplyItem[]
  stocks                ScmStock[]
  inventoryBalances     InventoryBalance[]
  inventoryTransactions InventoryTransaction[] @relation("InventoryTransactions")

  @@unique([supplierId, code])
  @@index([supplierId])
  @@index([type])
  @@index([category])
  @@index([isActive])
  @@map("supplier_items")
}

model ScmBomItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productId String
  product   ScmProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  supplierItemId String
  supplierItem   SupplierItem @relation(fields: [supplierItemId], references: [id], onDelete: Cascade)

  quantity Decimal @db.Decimal(14, 4)
  unit     String

  wastagePercent Decimal? @db.Decimal(5, 2)
  isOptional     Boolean  @default(false)

  note String? @db.Text

  @@index([productId])
  @@index([supplierItemId])
  @@map("scm_bom_items")
}

// ============================================
// 12. Production Orders
// ============================================

model ProductionOrder {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  code String @unique
  name String

  productId String
  product   ScmProduct @relation(fields: [productId], references: [id], onDelete: Restrict)

  quantityPlanned Decimal @db.Decimal(14, 4)
  unit            String

  status ProductionOrderStatus @default(PLANNED)

  plannedStartAt DateTime?
  plannedEndAt   DateTime?
  actualStartAt  DateTime?
  actualEndAt    DateTime?

  productionSite String? @db.Text
  notes          String? @db.Text

  productionCountryId String?
  productionCountry   Country? @relation("ProductionOrderCountry", fields: [productionCountryId], references: [id], onDelete: SetNull)

  manufacturerId String?
  manufacturer   Supplier? @relation("ProductionOrderManufacturer", fields: [manufacturerId], references: [id], onDelete: SetNull)

  items              ProductionOrderItem[]
  supplies           ScmSupply[]
  serviceOperations  ScmServiceOperation[] @relation("ProductionOrderServiceOperations")
  financialDocuments FinancialDocument[]   @relation("ProductionOrderFinancialDocuments")
  warehouse          Warehouse?            @relation(fields: [warehouseId], references: [id])
  warehouseId        String?

  @@index([productId])
  @@index([status])
  @@index([code])
  @@map("production_orders")
}

model ProductionOrderItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productionOrderId String
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)

  supplierItemId String
  supplierItem   SupplierItem @relation(fields: [supplierItemId], references: [id], onDelete: Restrict)

  quantityPlanned Decimal @db.Decimal(14, 4)
  quantityUnit    String

  quantityReceived Decimal? @db.Decimal(14, 4)

  status ProductionOrderItemStatus @default(PLANNED)

  expectedDate DateTime?
  receivedDate DateTime?

  fromBom Boolean @default(true)

  note String? @db.Text

  supplyItems ScmSupplyItem[]

  @@index([productionOrderId])
  @@index([supplierItemId])
  @@index([status])
  @@map("production_order_items")
}

// ============================================
// 13. Warehouses
// ============================================

model Warehouse {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name String
  code String        @unique
  type WarehouseType @default(OWN)

  countryId String?
  country   Country? @relation(fields: [countryId], references: [id], onDelete: SetNull)

  city     String?
  address  String? @db.Text
  isActive Boolean @default(true)
  notes    String? @db.Text

  stocks                ScmStock[]
  supplies              ScmSupply[]
  productionOrders      ProductionOrder[]
  inventoryBalances     InventoryBalance[]     @relation("InventoryBalances")
  inventoryTransactions InventoryTransaction[] @relation("InventoryTransactions")

  @@index([countryId])
  @@index([isActive])
  @@index([type])
  @@map("warehouses")
}

// ============================================
// 14. SCM Stocks (Extended)
// ============================================

model ScmStock {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  scmProductId String? // для готового товара
  scmProduct   ScmProduct? @relation(fields: [scmProductId], references: [id], onDelete: Cascade)

  supplierItemId String? // для сырья/упаковки
  supplierItem   SupplierItem? @relation(fields: [supplierItemId], references: [id], onDelete: Cascade)

  quantity Decimal @db.Decimal(14, 4)
  unit     String

  @@unique([warehouseId, scmProductId, supplierItemId])
  @@index([warehouseId])
  @@index([scmProductId])
  @@index([supplierItemId])
  @@map("scm_stocks")
}

// ============================================
// 15. SCM Supplies (Extended)
// ============================================

model ScmSupply {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  code   String          @unique
  status ScmSupplyStatus @default(DRAFT)

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Restrict)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Restrict)

  productionOrderId String?
  productionOrder   ProductionOrder? @relation(fields: [productionOrderId], references: [id], onDelete: SetNull)

  currency    String  @default("RUB")
  totalAmount Decimal @default(0) @db.Decimal(14, 4)

  orderDate    DateTime?
  expectedDate DateTime?
  receivedDate DateTime?

  comment String? @db.Text

  items                 ScmSupplyItem[]
  services              ScmServiceOperation[]
  financialDocuments    FinancialDocument[]    @relation("SupplyFinancialDocuments")
  inventoryTransactions InventoryTransaction[]

  @@index([supplierId])
  @@index([warehouseId])
  @@index([productionOrderId])
  @@index([status])
  @@index([code])
  @@map("scm_supplies")
}

// ============================================
// 16. SCM Supply Items
// ============================================

model ScmSupplyItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplyId String
  supply   ScmSupply @relation(fields: [supplyId], references: [id], onDelete: Cascade)

  supplierItemId String?
  supplierItem   SupplierItem? @relation(fields: [supplierItemId], references: [id], onDelete: SetNull)

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  description String? @db.Text

  unit String

  quantityOrdered  Decimal @default(0) @db.Decimal(14, 4)
  quantityReceived Decimal @default(0) @db.Decimal(14, 4)

  pricePerUnit Decimal @default(0) @db.Decimal(14, 4)
  currency     String

  productionOrderItemId String?
  productionOrderItem   ProductionOrderItem? @relation(fields: [productionOrderItemId], references: [id], onDelete: SetNull)

  inventoryTransactions InventoryTransaction[]

  @@index([supplyId])
  @@index([supplierItemId])
  @@index([productId])
  @@index([productionOrderItemId])
  @@map("scm_supply_items")
}

// ============================================
// 16.1. Inventory Balance
// ============================================

model InventoryBalance {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  warehouseId String
  warehouse   Warehouse @relation("InventoryBalances", fields: [warehouseId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  supplierItemId String?
  supplierItem   SupplierItem? @relation(fields: [supplierItemId], references: [id], onDelete: Cascade)

  quantity Decimal @default(0) @db.Decimal(14, 4)

  @@unique([warehouseId, productId, supplierItemId])
  @@index([warehouseId])
  @@index([productId])
  @@index([supplierItemId])
  @@map("inventory_balances")
}

// ============================================
// 16.2. Inventory Transactions
// ============================================

enum InventoryDirection {
  IN // приход
  OUT // расход
}

model InventoryTransaction {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  warehouseId String
  warehouse   Warehouse @relation("InventoryTransactions", fields: [warehouseId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation("InventoryTransactions", fields: [productId], references: [id], onDelete: SetNull)

  supplierItemId String?
  supplierItem   SupplierItem? @relation("InventoryTransactions", fields: [supplierItemId], references: [id], onDelete: SetNull)

  supplyId String?
  supply   ScmSupply? @relation(fields: [supplyId], references: [id], onDelete: SetNull)

  supplyItemId String?
  supplyItem   ScmSupplyItem? @relation(fields: [supplyItemId], references: [id], onDelete: SetNull)

  direction InventoryDirection
  quantity  Decimal            @db.Decimal(14, 4)
  comment   String?            @db.Text

  @@index([warehouseId])
  @@index([productId])
  @@index([supplierItemId])
  @@index([supplyId])
  @@index([supplyItemId])
  @@map("inventory_transactions")
}

// ============================================
// 17. SCM Service Operations
// ============================================

model ScmServiceOperation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplierId String?
  supplier   Supplier? @relation("SupplierServiceOperations", fields: [supplierId], references: [id], onDelete: SetNull)

  category ScmServiceCategory
  name     String

  productionOrderId String?
  productionOrder   ProductionOrder? @relation("ProductionOrderServiceOperations", fields: [productionOrderId], references: [id], onDelete: SetNull)

  supplyId String?
  supply   ScmSupply? @relation(fields: [supplyId], references: [id], onDelete: SetNull)

  quantity     Decimal? @db.Decimal(14, 4)
  unit         String?
  pricePerUnit Decimal? @db.Decimal(14, 4)
  totalAmount  Decimal  @db.Decimal(14, 4)
  currency     String

  financialDocumentId String?
  financialDocument   FinancialDocument? @relation("FinancialDocumentServices", fields: [financialDocumentId], references: [id], onDelete: SetNull)

  comment String? @db.Text

  @@index([supplierId])
  @@index([productionOrderId])
  @@index([supplyId])
  @@index([financialDocumentId])
  @@index([category])
  @@map("scm_service_operations")
}

// ============================================
// 17.1. Supplier Services (Catalog)
// ============================================

enum SupplierServiceCategory {
  PRODUCTION
  LOGISTICS
  OTHER
}

model SupplierService {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  name     String
  code     String?
  category SupplierServiceCategory @default(OTHER)
  unit     String

  basePrice Decimal? @db.Decimal(14, 4)
  currency  String?

  isActive Boolean @default(true)
  notes    String? @db.Text
  metadata Json? // резерв для специфики

  @@unique([supplierId, code], name: "unique_supplier_service_code")
  @@index([supplierId])
  @@index([category])
  @@index([isActive])
  @@map("supplier_services")
}

// ============================================
// 18. Financial Documents
// ============================================

model FinancialDocument {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Основные реквизиты документа
  docNumber String? // номер документа
  docDate   DateTime? // дата документа

  type      FinancialDocumentType? // тип документа
  direction FinancialDocumentDirection? // входящий / исходящий
  status    FinancialDocumentStatus?    @default(DRAFT)

  currency    String? // ISO-код, например "RUB", "USD"
  amountTotal Decimal?  @db.Decimal(14, 4) // сумма по документу
  amountPaid  Decimal?  @db.Decimal(14, 4) // сколько уже оплачено
  dueDate     DateTime? // срок оплаты

  // Связи
  supplierId String?
  supplier   Supplier? @relation("SupplierFinancialDocuments", fields: [supplierId], references: [id], onDelete: SetNull)

  productionOrderId String?
  productionOrder   ProductionOrder? @relation("ProductionOrderFinancialDocuments", fields: [productionOrderId], references: [id], onDelete: SetNull)

  scmSupplyId String?
  scmSupply   ScmSupply? @relation("SupplyFinancialDocuments", fields: [scmSupplyId], references: [id], onDelete: SetNull)

  // Future relations (models to be created)
  purchaseId String?
  expenseId  String?

  // Дополнительно
  externalId String? // ID из внешней системы (банк, 1С и т.п.)
  fileUrl    String? // ссылка на файл / объект в хранилище
  notes      String? @db.Text // комментарий

  // Legacy fields for backward compatibility
  number    String? // legacy, используем docNumber
  date      DateTime? // legacy, используем docDate
  issueDate DateTime? // дата выставления
  paidDate  DateTime? // дата полной оплаты (если статус PAID)

  // Связь с услугами
  services ScmServiceOperation[] @relation("FinancialDocumentServices")

  // Legacy field for backward compatibility
  comment String? @db.Text

  @@index([supplierId])
  @@index([productionOrderId])
  @@index([scmSupplyId])
  @@index([purchaseId])
  @@index([expenseId])
  @@index([status])
  @@index([docNumber])
  @@index([number]) // legacy index
  @@map("financial_documents")
}

// ============================================
// 11. BCM Listing Content Versions
// ============================================

enum ListingVersionSource {
  MANUAL // пользователь руками
  AI_AGENT // сгенерировал ИИ-агент
  IMPORT // импорт из внешней системы
}

model ListingContentVersion {
  id String @id @default(cuid())

  /// Ссылка на BCM Listing (Product)
  listingId String
  listing   Product @relation(fields: [listingId], references: [id], onDelete: Cascade)

  /// Ссылка на маркетплейс (опционально — на будущее, под OZON/WB и др.)
  marketplaceId String?
  marketplace   Marketplace? @relation(fields: [marketplaceId], references: [id])

  /// Порядковый номер версии (1, 2, 3, … для конкретного листинга)
  versionNumber Int

  /// От кого/чего пришли изменения
  source ListingVersionSource @default(MANUAL)

  /// Краткое текстовое описание причины изменения (опционально)
  reason String?

  /// Кто изменил (опционально, на будущее)
  createdByUserId String?
  createdBy       User?   @relation(fields: [createdByUserId], references: [id])

  /// Снапшот контентных полей листинга
  title            String?
  subtitle         String?
  shortDescription String?
  fullDescription  String?
  keywords         String?
  contentMeta      Json?

  createdAt DateTime @default(now())

  @@index([listingId, versionNumber])
  @@index([listingId])
  @@map("listing_content_versions")
}

// ============================================
// 12. BCM Product Content Versions (OZON)
// ============================================

enum ContentChangeSource {
  MANUAL
  AI
  SYSTEM
}

model ProductContentVersion {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  /// Marketplace code, например: "OZON" (на будущее, пока можно заполнять из product.marketplaceCode или null)
  marketplaceCode String?

  /// Номер версии (автоинкремент на productId)
  versionNumber Int

  /// Snapshot контента на момент изменения
  mpTitle            String? @db.Text
  mpSubtitle         String? @db.Text
  mpShortDescription String? @db.Text
  mpDescription      String? @db.Text
  keywords           String? @db.Text
  contentAttributes  Json?

  /// Источник изменения: MANUAL, AI, SYSTEM
  source ContentChangeSource @default(MANUAL)

  /// Кто инициировал: userId, если есть авторизованный пользователь
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  /// Опциональное имя AI-агента / описания источника (например: "ozon-content-agent-v1")
  agentLabel String?

  /// Необязательный комментарий (например, "Initial version", "Experiment A/B title test")
  comment String?

  createdAt DateTime @default(now())

  @@unique([productId, versionNumber])
  @@index([productId])
  @@index([productId, versionNumber])
  @@map("product_content_versions")
}
