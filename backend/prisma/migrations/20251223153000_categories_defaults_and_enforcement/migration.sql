-- TZ 6.1 — Categories enforcement + default mappings in DB

-- 0) Extend FinancialDocumentType enum (for explicit classification by type)
DO $$
BEGIN
  ALTER TYPE "FinancialDocumentType" ADD VALUE IF NOT EXISTS 'RENT';
  ALTER TYPE "FinancialDocumentType" ADD VALUE IF NOT EXISTS 'MARKETING';
  ALTER TYPE "FinancialDocumentType" ADD VALUE IF NOT EXISTS 'TAX';
  ALTER TYPE "FinancialDocumentType" ADD VALUE IF NOT EXISTS 'LOAN_PRINCIPAL';
  ALTER TYPE "FinancialDocumentType" ADD VALUE IF NOT EXISTS 'LOAN_INTEREST';
  ALTER TYPE "FinancialDocumentType" ADD VALUE IF NOT EXISTS 'DIVIDEND';
EXCEPTION
  WHEN duplicate_object THEN NULL;
END
$$;

-- 1) Mapping source type enum
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'FinanceCategoryMappingSourceType') THEN
    CREATE TYPE "FinanceCategoryMappingSourceType" AS ENUM (
      'FINANCIAL_DOCUMENT_TYPE',
      'PAYMENT_REQUEST_TYPE',
      'STATEMENT_OPERATION_HINT',
      'MONEY_TRANSACTION_SOURCE_TYPE'
    );
  END IF;
END $$;

-- 2) Finance category default mappings table
CREATE TABLE IF NOT EXISTS "finance_category_default_mappings" (
  "id" TEXT NOT NULL,
  "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMP(3) NOT NULL,
  "legalEntityId" TEXT,
  "sourceType" "FinanceCategoryMappingSourceType" NOT NULL,
  "sourceCode" TEXT NOT NULL,
  "defaultCashflowCategoryId" TEXT,
  "defaultPnlCategoryId" TEXT,
  "priority" INTEGER NOT NULL DEFAULT 100,
  "isActive" BOOLEAN NOT NULL DEFAULT true,
  CONSTRAINT "finance_category_default_mappings_pkey" PRIMARY KEY ("id")
);

CREATE UNIQUE INDEX IF NOT EXISTS "finance_category_default_mappings_unique_key"
  ON "finance_category_default_mappings"("legalEntityId","sourceType","sourceCode");

CREATE INDEX IF NOT EXISTS "finance_category_default_mappings_lookup_idx"
  ON "finance_category_default_mappings"("legalEntityId","sourceType","isActive","priority");

DO $$
BEGIN
  ALTER TABLE "finance_category_default_mappings"
    ADD CONSTRAINT "finance_category_default_mappings_legalEntityId_fkey"
    FOREIGN KEY ("legalEntityId") REFERENCES "legal_entities"("id")
    ON DELETE CASCADE ON UPDATE CASCADE;
EXCEPTION
  WHEN duplicate_object THEN NULL;
END
$$;

DO $$
BEGIN
  ALTER TABLE "finance_category_default_mappings"
    ADD CONSTRAINT "finance_category_default_mappings_defaultCashflowCategoryId_fkey"
    FOREIGN KEY ("defaultCashflowCategoryId") REFERENCES "cashflow_categories"("id")
    ON DELETE SET NULL ON UPDATE CASCADE;
EXCEPTION
  WHEN duplicate_object THEN NULL;
END
$$;

DO $$
BEGIN
  ALTER TABLE "finance_category_default_mappings"
    ADD CONSTRAINT "finance_category_default_mappings_defaultPnlCategoryId_fkey"
    FOREIGN KEY ("defaultPnlCategoryId") REFERENCES "pnl_categories"("id")
    ON DELETE SET NULL ON UPDATE CASCADE;
EXCEPTION
  WHEN duplicate_object THEN NULL;
END
$$;

-- 3) MoneyTransaction: optional cashflowCategoryId
ALTER TABLE "money_transactions"
  ADD COLUMN IF NOT EXISTS "cashflowCategoryId" TEXT;

CREATE INDEX IF NOT EXISTS "money_transactions_cashflowCategoryId_idx"
  ON "money_transactions"("cashflowCategoryId");

DO $$
BEGIN
  ALTER TABLE "money_transactions"
    ADD CONSTRAINT "money_transactions_cashflowCategoryId_fkey"
    FOREIGN KEY ("cashflowCategoryId") REFERENCES "cashflow_categories"("id")
    ON DELETE SET NULL ON UPDATE CASCADE;
EXCEPTION
  WHEN duplicate_object THEN NULL;
END
$$;

-- 4) Minimal seeds (global defaults) — create categories by code if missing
-- NOTE: IDs are explicit because tables use app-level UUIDs (no DB default).
-- Cashflow categories
INSERT INTO "cashflow_categories" ("id","createdAt","updatedAt","code","name","parentId","isActive")
VALUES
  ('11111111-1111-1111-1111-111111111111', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'CF_RENT', 'Rent', NULL, true),
  ('11111111-1111-1111-1111-111111111112', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'CF_MARKETING', 'Marketing', NULL, true),
  ('11111111-1111-1111-1111-111111111113', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'CF_TAX', 'Taxes', NULL, true),
  ('11111111-1111-1111-1111-111111111114', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'CF_SUPPLIERS', 'Suppliers', NULL, true),
  ('11111111-1111-1111-1111-111111111115', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'CF_FINANCING', 'Financing', NULL, true),
  ('11111111-1111-1111-1111-111111111116', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'CF_MARKETPLACE_FEES', 'Marketplace fees', NULL, true),
  ('11111111-1111-1111-1111-111111111117', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'CF_ACQUIRING_FEES', 'Acquiring fees', NULL, true),
  ('11111111-1111-1111-1111-111111111118', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'CF_TRANSFER_INTERNAL', 'Internal transfers', NULL, true)
ON CONFLICT ("code") DO NOTHING;

-- P&L categories
INSERT INTO "pnl_categories" ("id","createdAt","updatedAt","code","name","parentId","isActive")
VALUES
  ('22222222-2222-2222-2222-222222222221', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'PNL_RENT', 'Rent', NULL, true),
  ('22222222-2222-2222-2222-222222222222', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'PNL_MARKETING', 'Marketing', NULL, true),
  ('22222222-2222-2222-2222-222222222223', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'PNL_TAX', 'Taxes', NULL, true),
  ('22222222-2222-2222-2222-222222222224', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'PNL_INTEREST', 'Interest', NULL, true),
  ('22222222-2222-2222-2222-222222222225', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'PNL_MARKETPLACE_FEES', 'Marketplace fees', NULL, true),
  ('22222222-2222-2222-2222-222222222226', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'PNL_ACQUIRING_FEES', 'Acquiring fees', NULL, true)
ON CONFLICT ("code") DO NOTHING;

-- 5) Minimal default mappings (global)
-- helper: map codes to ids via fixed ids above
INSERT INTO "finance_category_default_mappings"
  ("id","createdAt","updatedAt","legalEntityId","sourceType","sourceCode","defaultCashflowCategoryId","defaultPnlCategoryId","priority","isActive")
VALUES
  -- Financial documents
  ('33333333-3333-3333-3333-333333333301', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'FINANCIAL_DOCUMENT_TYPE', 'RENT',
    '11111111-1111-1111-1111-111111111111', '22222222-2222-2222-2222-222222222221', 100, true),
  ('33333333-3333-3333-3333-333333333302', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'FINANCIAL_DOCUMENT_TYPE', 'MARKETING',
    '11111111-1111-1111-1111-111111111112', '22222222-2222-2222-2222-222222222222', 100, true),
  ('33333333-3333-3333-3333-333333333303', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'FINANCIAL_DOCUMENT_TYPE', 'TAX',
    '11111111-1111-1111-1111-111111111113', '22222222-2222-2222-2222-222222222223', 100, true),
  ('33333333-3333-3333-3333-333333333304', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'FINANCIAL_DOCUMENT_TYPE', 'SUPPLY_INVOICE',
    '11111111-1111-1111-1111-111111111114', NULL, 100, true),
  ('33333333-3333-3333-3333-333333333305', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'FINANCIAL_DOCUMENT_TYPE', 'LOAN_PRINCIPAL',
    '11111111-1111-1111-1111-111111111115', NULL, 100, true),
  ('33333333-3333-3333-3333-333333333306', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'FINANCIAL_DOCUMENT_TYPE', 'LOAN_INTEREST',
    '11111111-1111-1111-1111-111111111115', '22222222-2222-2222-2222-222222222224', 100, true),
  ('33333333-3333-3333-3333-333333333307', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'FINANCIAL_DOCUMENT_TYPE', 'DIVIDEND',
    '11111111-1111-1111-1111-111111111115', NULL, 100, true),
  -- Payment requests
  ('33333333-3333-3333-3333-333333333311', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'PAYMENT_REQUEST_TYPE', 'RENT',
    '11111111-1111-1111-1111-111111111111', '22222222-2222-2222-2222-222222222221', 100, true),
  ('33333333-3333-3333-3333-333333333312', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'PAYMENT_REQUEST_TYPE', 'MARKETING',
    '11111111-1111-1111-1111-111111111112', '22222222-2222-2222-2222-222222222222', 100, true),
  ('33333333-3333-3333-3333-333333333313', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'PAYMENT_REQUEST_TYPE', 'TAX',
    '11111111-1111-1111-1111-111111111113', '22222222-2222-2222-2222-222222222223', 100, true),
  ('33333333-3333-3333-3333-333333333314', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'PAYMENT_REQUEST_TYPE', 'LOAN',
    '11111111-1111-1111-1111-111111111115', NULL, 100, true),
  ('33333333-3333-3333-3333-333333333315', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'PAYMENT_REQUEST_TYPE', 'DIVIDEND',
    '11111111-1111-1111-1111-111111111115', NULL, 100, true),
  ('33333333-3333-3333-3333-333333333316', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'PAYMENT_REQUEST_TYPE', 'TRANSFER',
    '11111111-1111-1111-1111-111111111118', NULL, 100, true),
  -- Statement operation hints
  ('33333333-3333-3333-3333-333333333321', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'STATEMENT_OPERATION_HINT', 'MARKETPLACE_FEE',
    '11111111-1111-1111-1111-111111111116', '22222222-2222-2222-2222-222222222225', 100, true),
  ('33333333-3333-3333-3333-333333333322', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'STATEMENT_OPERATION_HINT', 'ACQUIRING_FEE',
    '11111111-1111-1111-1111-111111111117', '22222222-2222-2222-2222-222222222226', 100, true),
  -- Money transaction source type
  ('33333333-3333-3333-3333-333333333331', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, 'MONEY_TRANSACTION_SOURCE_TYPE', 'INTERNAL_TRANSFER',
    '11111111-1111-1111-1111-111111111118', NULL, 100, true)
ON CONFLICT ("legalEntityId","sourceType","sourceCode") DO NOTHING;





