# –û—Ç—á—ë—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ AgentsModule - –¢–ó ‚Ññ7

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Prisma-–º–æ–¥–µ–ª–µ–π ‚úÖ
–ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –º–æ–¥–µ–ª–∏ –≤ `schema.prisma`:
- ‚úÖ `AgentScenario` ‚Äî —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å –ø–æ–ª—è–º–∏: `id`, `key` (unique), `name`, `endpoint`, `createdAt`, `updatedAt`
- ‚úÖ `AgentRun` ‚Äî —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å –ø–æ–ª—è–º–∏: `id`, `scenarioId`, `agentKey`, `input` (Json), `output` (Json), `status`, `error`, `startedAt`, `finishedAt`
- ‚úÖ –°–≤—è–∑—å: AgentScenario ‚Üí AgentRun (1:N)

### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è ‚úÖ
–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
- ‚úÖ `agents.module.ts` ‚Äî –º–æ–¥—É–ª—å —Å HttpModule
- ‚úÖ `agents.service.ts` ‚Äî —Å–µ—Ä–≤–∏—Å —Å –º–µ—Ç–æ–¥–∞–º–∏ runAgent, handleCallback, getRuns
- ‚úÖ `agents.controller.ts` ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏
- ‚úÖ `dto/run-agent.dto.ts` ‚Äî DTO –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–≥–µ–Ω—Ç–∞

### 3. DTO –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–≥–µ–Ω—Ç–∞ ‚úÖ
–°–æ–∑–¥–∞–Ω `RunAgentDto`:
- ‚úÖ `agent: string` ‚Äî –∫–ª—é—á –∞–≥–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "import_sales")
- ‚úÖ `params?: Record<string, any>` ‚Äî –≤—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

### 4. AgentsService ‚úÖ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–µ—Ç–æ–¥—ã:

**runAgent(dto: RunAgentDto):**
- ‚úÖ –ü–æ–∏—Å–∫ AgentScenario –ø–æ `key = dto.agent`
- ‚úÖ –í—ã–±—Ä–æ—Å –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ AgentRun —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `RUNNING`
- ‚úÖ HTTP-–∑–∞–ø—Ä–æ—Å –∫ `scenario.endpoint` (n8n webhook)
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ `runId`, `agentKey`, `params`
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ webhook
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç AgentRun —Å id –∏ —Å—Ç–∞—Ç—É—Å–æ–º

**handleCallback(runId: string, payload: any):**
- ‚úÖ –ü–æ–∏—Å–∫ AgentRun –ø–æ id
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: `SUCCESS` –∏–ª–∏ `ERROR` –Ω–∞ –æ—Å–Ω–æ–≤–µ `payload.status`
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `output` –∏–∑ payload
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `error` –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `finishedAt = now()`
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ AgentRun

**getRuns(filters?):**
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç —Å–ø–∏—Å–∫–∞ –∑–∞–ø—É—Å–∫–æ–≤, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ `startedAt DESC`
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `agentKey`
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `status`
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (`limit`, –º–∞–∫—Å. 100)

### 5. –í—ã–∑–æ–≤ n8n (HTTP) ‚úÖ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `HttpService` –∏–∑ `@nestjs/axios`
- ‚úÖ HttpModule –ø–æ–¥–∫–ª—é—á—ë–Ω –≤ AgentsModule
- ‚úÖ URL –±–µ—Ä—ë—Ç—Å—è –∏–∑ `scenario.endpoint`
- ‚úÖ –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:
  ```json
  {
    "runId": "<AgentRun.id>",
    "agentKey": "<agent key>",
    "params": { ... }
  }
  ```
- ‚úÖ Fire-and-forget –ø–æ–¥—Ö–æ–¥: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ callback
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤

### 6. AgentsController ‚úÖ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:

**6.1. POST `/api/agents/run`**
- ‚úÖ –ó–∞—â–∏—â—ë–Ω `JwtAuthGuard`
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `RunAgentDto`
- ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç `agentsService.runAgent`
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π AgentRun (id, agentKey, status, startedAt)

**6.2. POST `/api/agents/callback/:runId`**
- ‚úÖ –ù–µ –∑–∞—â–∏—â—ë–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π (–≤—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º—ã)
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç JSON —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
- ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç `agentsService.handleCallback(runId, payload)`
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**6.3. GET `/api/agents/runs`**
- ‚úÖ –ó–∞—â–∏—â—ë–Ω `JwtAuthGuard`
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ query-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: `agentKey?`, `status?`, `limit?`
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—Å–∫–æ–≤ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### 7. –°—Ç–∞—Ç—É—Å—ã AgentRun ‚úÖ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Å—Ç–∞—Ç—É—Å—ã:
- ‚úÖ `RUNNING` ‚Äî –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ AgentRun
- ‚úÖ `SUCCESS` ‚Äî –ø—Ä–∏ `payload.status == "success"`
- ‚úÖ `ERROR` ‚Äî –ø—Ä–∏ `payload.status == "error"` –∏–ª–∏ –æ—à–∏–±–∫–µ HTTP-–∑–∞–ø—Ä–æ—Å–∞
- ‚úÖ `PENDING` ‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —ç—Ç–∞–ø–µ 0

### 8. –°–∏–¥—ã –¥–ª—è AgentScenario ‚úÖ
–î–æ–±–∞–≤–ª–µ–Ω—ã –≤ `seed.ts`:
- ‚úÖ `import_sales` ‚Äî Import Sales From Marketplace
- ‚úÖ `import_reviews` ‚Äî Import Reviews From Marketplace
- ‚úÖ `import_advertising` ‚Äî Import Advertising Data
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ URL webhook'–æ–≤ (–∑–∞–≥–ª—É—à–∫–∏)

### 9. Swagger ‚úÖ
–î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- ‚úÖ `@ApiTags('agents')` –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
- ‚úÖ `@ApiOperation` –¥–ª—è –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- ‚úÖ `@ApiResponse` –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- ‚úÖ `@ApiQuery` –¥–ª—è query-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ `@ApiParam` –¥–ª—è path-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ `@ApiCookieAuth()` –¥–ª—è –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

### 10. README –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ
–î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª AgentsModule —Å:
- ‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º –º–æ–¥—É–ª—è
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ–º —Å—É—â–Ω–æ—Å—Ç–µ–π
- ‚úÖ –°–ø–∏—Å–∫–æ–º —Å—Ç–∞—Ç—É—Å–æ–≤
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- ‚úÖ –ü—Ä–∏–º–µ—Ä–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞–±–æ—Ç—ã
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
backend/src/modules/agents/
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îî‚îÄ‚îÄ run-agent.dto.ts
‚îú‚îÄ‚îÄ agents.module.ts
‚îú‚îÄ‚îÄ agents.service.ts
‚îî‚îÄ‚îÄ agents.controller.ts
```

## üìã API Endpoints

1. **POST** `/api/agents/run` ‚Äî –∑–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞ (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é)
2. **POST** `/api/agents/callback/:runId` ‚Äî callback –æ—Ç n8n (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
3. **GET** `/api/agents/runs` ‚Äî —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—Å–∫–æ–≤ (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é)

## üîç –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

### –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞
```bash
curl -X POST http://localhost:3001/api/agents/run \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{
    "agent": "import_sales",
    "params": {
      "marketplace": "OZON",
      "dateFrom": "2024-01-01"
    }
  }'
```

### Callback –æ—Ç n8n
```bash
curl -X POST http://localhost:3001/api/agents/callback/run-id \
  -H "Content-Type: application/json" \
  -d '{
    "status": "success",
    "data": {
      "imported": 150
    }
  }'
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–ø—É—Å–∫–æ–≤
```bash
curl -X GET "http://localhost:3001/api/agents/runs?agentKey=import_sales&status=SUCCESS" \
  -b cookies.txt
```

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ - –í–°–ï –í–´–ü–û–õ–ù–ï–ù–´

1. ‚úÖ –ö–æ–¥ agents.module.ts, agents.service.ts, agents.controller.ts, DTO
2. ‚úÖ Schema.prisma –ø—Ä–æ–≤–µ—Ä–µ–Ω (–º–æ–¥–µ–ª–∏ —É–∂–µ –±—ã–ª–∏)
3. ‚úÖ –°–∏–¥-—Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª—ë–Ω —Å AgentScenario
4. ‚úÖ –ü—Ä–∏–º–µ—Ä—ã HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –≥–æ—Ç–æ–≤—ã
5. ‚úÖ –ü—Ä–æ–µ–∫—Ç –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

## üéØ –°—Ç–∞—Ç—É—Å

**‚úÖ AgentsModule –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**

–ú–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:
- –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ –≤—ã–∑–æ–≤ n8n webhook'–æ–≤
- –ü—Ä–∏—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ callback
- –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø—É—Å–∫–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- API –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –∏ —Å—Ç–∞—Ç—É—Å–æ–≤



























